<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>356地图守护</title>
</head>
<body>
    <h1>正在加载地图中</h1>

    <script>
        function base64Encode(bytes){
          const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";
          let out = "", i;
          for(i=0;i<bytes.length;i+=3){
            let b1 = bytes[i], b2 = i+1<bytes.length?bytes[i+1]:0, b3=i+2<bytes.length?bytes[i+2]:0;
            let triplet = (b1<<16)|(b2<<8)|b3;
            out += chars[(triplet>>18)&0x3F];
            out += chars[(triplet>>12)&0x3F];
            out += i+1<bytes.length?chars[(triplet>>6)&0x3F]:'=';
            out += i+2<bytes.length?chars[triplet&0x3F]:'=';
          }
          return out;
        }
        function base64Decode(str){
          const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";
          let bytes=[], i=0;
          while(i<str.length){
                let c1=chars.indexOf(str[i++]);
                let c2=chars.indexOf(str[i++]);
                let c3=chars.indexOf(str[i++]);
                let c4=chars.indexOf(str[i++]);
                let triplet=(c1<<18)|(c2<<12)|((c3&63)<<6)|(c4&63);
                bytes.push((triplet>>16)&0xFF);
                if(c3!=64) bytes.push((triplet>>8)&0xFF);
                if(c4!=64) bytes.push(triplet&0xFF);
          }
            return bytes;
          }

        function strToBytes(str){
          let bytes=[];
            for(let i=0;i<str.length;i++) bytes.push(str.charCodeAt(i));
              return bytes;
        }

        function bytesToStr(bytes){
          return bytes.map(b=>String.fromCharCode(b)).join('');
        }
        function genKey(len){
          let key = [];
          let seed = 12345;
          for(let i=0;i<len;i++){
            seed = (seed*1103515245+12345) & 0x7fffffff;
            key.push(seed % 256);
          }
          return key;
        }
        function encrypt(ip){
          let data = strToBytes(ip);
          let key = genKey(data.length);
          let out = new Array(data.length);
          for(let i=0;i<data.length;i++){
            out[i] = data[i]^key[i];
          }
          return base64Encode(out);
        }
        function convertLink(url) {
          const pattern = /^https?:\/\/view\.dao3\.fun\/p\//;
          if (pattern.test(url)) {
            return url.replace(pattern, "https://dao3.fun/play/");
          }
          return url;
        }
        
        fetch('https://api.ipgeolocation.io/getip')
        .then(response => response.json())
        .then(data => {
                const encryptedIP = encrypt(data.ip);
                let params=new URLSearchParams(window.location.search).get('mapid');
                const result = convertLink(params);
                const targetUrl = `${result}?key=${encryptedIP}`;
                window.location.href = targetUrl;
                console.log(targetUrl)
        })
    </script>
</body>
</html>





